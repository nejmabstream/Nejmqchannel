import re
import requests
import telepot
import schedule
import time

# إعدادات البوت
BOT_TOKEN = "7710008981:AAHPz0QR48jwkRe4tPynOR-SpKPeySnyJUw"
CHAT_IDS = ["6444681745", "11", "11", "11"]

# رابط ملف GitHub الذي يحتوي على الروابط
GITHUB_URL = "https://raw.githubusercontent.com/nejmabstream/Nejmqchannel/main/com.styog.yallanajmapr.html"

# إنشاء الاتصال مع البوت
bot = telepot.Bot(BOT_TOKEN)

# تخزين آخر الروابط المرسلة لتجنب التكرار
last_sent_links = set()

# قائمة القنوات بالترتيب المطلوب
CHANNEL_ORDER = [
    "beIN Sport News", "beIN Sport 1", "beIN Sport 2", "beIN Sport 3",
    "beIN Sport 4", "beIN Sport 5", "beIN Sport 6", "beIN Sport 7",
    "beIN Sport 8", "beIN Sport 9", "beIN Sport 10",
    "SSC EXTRA 11", "AD SPORTS 12", "RIADDIA 13", "EXTRA 13"
]

# دالة لاستخراج الروابط من النص
def extract_video_links(text):
    pattern = r"https://video[^\s;]+"  # البحث عن الروابط التي تبدأ بـ https://video
    return list(set(re.findall(pattern, text)))  # استخدام set لتجنب التكرار

# دالة إرسال قائمة القنوات مع الروابط
def send_channels_with_links(links):
    message = "📡 **قائمة القنوات المحدثة:**\n\n"

    for idx, channel in enumerate(CHANNEL_ORDER, start=1):
        link = links[idx - 1] if idx - 1 < len(links) else None  # التحقق من وجود الرابط

        if link:
            message += f"✅ **#{channel}**\n🔗 [مشاهدة البث المباشر]({link})\n\n"
        else:
            message += f"❌ **#{channel}** (لا يوجد رابط حاليًا)\n\n"

    for chat_id in CHAT_IDS:
        try:
            bot.sendMessage(chat_id, message, parse_mode="Markdown", disable_web_page_preview=True)
            print(f"✅ تم إرسال القائمة إلى {chat_id}")
        except Exception as e:
            print(f"❗ خطأ في إرسال القائمة إلى {chat_id}: {e}")

# دالة لجلب المحتوى وإرسال الروابط
def fetch_and_send_links():
    global last_sent_links
    try:
        print("🔄 جاري جلب البيانات من GitHub...")
        response = requests.get(GITHUB_URL, timeout=5)

        if response.status_code == 200:
            content = response.text
            video_links = extract_video_links(content)  # استخراج الروابط

            # تحديد الروابط الجديدة فقط
            new_links = set(video_links) - last_sent_links  # تحديد الروابط الجديدة فقط

            if new_links:  # في حال وجود روابط جديدة
                last_sent_links.update(new_links)  # تحديث قائمة الروابط المرسلة
                send_channels_with_links(list(new_links))  # إرسال الروابط الجديدة
                print(f"✅ تم إرسال {len(new_links)} رابط جديد.")
            else:
                print("⚠️ لا توجد روابط جديدة!")

        else:
            print(f"❌ فشل في جلب المحتوى. الحالة: {response.status_code}")

    except requests.exceptions.RequestException as e:
        print(f"❗ خطأ في جلب البيانات: {e}")

# **إرسال أول دفعة فورًا عند التشغيل**
fetch_and_send_links()

# **جدولة الإرسال كل 1 دقيقة**
schedule.every(1).minutes.do(fetch_and_send_links)

# **تشغيل الجدولة بدون 
